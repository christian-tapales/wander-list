{% extends 'base.html' %}

{% block title %}PisoHeroes | Log Expense{% endblock %}

{% block content %}
<main class="container-fluid flex-grow-1 dashboard-content"> 
    
    <h1 class="dashboard-title">Log Expense</h1> 

    <div class="g-4 mb-4 content-panels">
        
            <div class="card log-expense-card h-100">
                <div class="card-body">
                    <h2>Log New Expense</h2>
                    <p class="card-subtitle">Quickly add and categorize your daily expenses to keep track of your spending.</p>

                    <form method="post" action="" class="expense-form">
                        {% csrf_token %}

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="amount">Amount:</label>
                                    <div class="input-with-icon">
                                        <span>₱</span>
                                        <input type="number" 
                                               id="amount" 
                                               name="amount" 
                                               step="0.01" 
                                               min="0.01" 
                                               max="999999999.99"
                                               class="form-control" 
                                               placeholder="0.00"
                                               required>
                                    </div>
                                    <small class="form-text text-muted">Enter amount greater than zero</small>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="category">Category:</label>
                                    <select id="category" name="category" class="form-control" required>
                                        <option value="">-- Select Category --</option>
                                        {% for cat in categories %}
                                            <option value="{{ cat }}">{{ cat }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mt-3">
                            <label for="date">Date:</label>
                            <input type="date" 
                                   id="date" 
                                   name="date" 
                                   class="form-control" 
                                   value="{% now 'Y-m-d' %}" 
                                   required>
                        </div>

                        <div class="form-group mt-3">
                            <label for="notes">Notes (optional):</label>
                            <textarea id="notes" 
                                      name="notes" 
                                      class="form-control" 
                                      rows="3" 
                                      placeholder="Add any additional details..."></textarea>
                        </div>

                        <div class="form-actions d-flex justify-content-end gap-3 mt-4">
                            <button type="reset" class="btn btn-outline-secondary">Clear Form</button>
                            <button type="submit" class="btn btn-success">Add Expense</button>
                        </div>
                    </form>

                    <script>
                        // Client-side validation for expense form
                        document.querySelector('.expense-form').addEventListener('submit', function(e) {
                            const amount = parseFloat(document.getElementById('amount').value);
                            const category = document.getElementById('category').value;
                            
                            // Validate amount
                            if (isNaN(amount) || amount <= 0) {
                                e.preventDefault();
                                alert('⚠️ Please enter a valid amount greater than zero.');
                                return false;
                            }
                            
                            if (amount > 999999999.99) {
                                e.preventDefault();
                                alert('⚠️ Amount is too large. Maximum is ₱999,999,999.99');
                                return false;
                            }
                            
                            // Validate category
                            if (!category || category === '') {
                                e.preventDefault();
                                alert('⚠️ Please select a category.');
                                return false;
                            }
                            
                            return true;
                        });
                        
                        // Prevent negative values on input
                        document.getElementById('amount').addEventListener('input', function(e) {
                            if (this.value < 0) {
                                this.value = 0;
                            }
                        });
                    </script>
                </div>
            </div>

            <div class="card recent-expenses-card h-100">
                <div class="card-body">
                    <h2 class="card-header mb-3">Recent Expenses</h2>
                    
                    <div class="expense-list">
                        {% for expense in recent_expenses %}
                            <div class="expense-item d-flex justify-content-between align-items-center py-3 border-bottom">
                                <div class="expense-details flex-grow-1">
                                    <div class="d-flex align-items-center gap-3">
                                        <span class="expense-category fw-bold">{{ expense.category }}</span>
                                        <span class="expense-date text-muted small">{{ expense.date }}</span>
                                    </div>
                                    {% if expense.notes %}
                                        <div class="expense-notes text-muted small mt-1">{{ expense.notes }}</div>
                                    {% endif %}
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="expense-amount text-danger fw-semibold">₱{{ expense.amount }}</span>
                                    <button class="btn btn-sm btn-outline-primary edit-btn" 
                                            data-id="{{ expense.id }}"
                                            data-amount="{{ expense.amount }}"
                                            data-category="{{ expense.category }}"
                                            data-date="{{ expense.date }}"
                                            data-notes="{{ expense.notes }}"
                                            title="Edit expense">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <form method="post" action="{% url 'delete_expense' expense.id %}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this expense?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete expense">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-muted">No expenses yet. Start tracking your spending!</div>
                        {% endfor %}
                    </div>
                
                </div>
            </div>
    </div>

    <!-- Edit Expense Modal -->
    <div class="modal fade" id="editExpenseModal" tabindex="-1" aria-labelledby="editExpenseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editExpenseModalLabel">Edit Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" id="editExpenseForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" id="edit-expense-id" name="expense_id">
                        
                        <div class="mb-3">
                            <label for="edit-amount" class="form-label">Amount:</label>
                            <div class="input-group">
                                <span class="input-group-text">₱</span>
                                <input type="number" 
                                       id="edit-amount" 
                                       name="amount" 
                                       step="0.01" 
                                       min="0.01" 
                                       max="999999999.99"
                                       class="form-control" 
                                       required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="edit-category" class="form-label">Category:</label>
                            <select id="edit-category" name="category" class="form-control" required>
                                <option value="">-- Select Category --</option>
                                {% for cat in categories %}
                                    <option value="{{ cat }}">{{ cat }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="edit-date" class="form-label">Date:</label>
                            <input type="date" id="edit-date" name="date" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label for="edit-notes" class="form-label">Notes (optional):</label>
                            <textarea id="edit-notes" name="notes" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Expense</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Handle edit button clicks
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const expenseId = this.dataset.id;
                const amount = this.dataset.amount;
                const category = this.dataset.category;
                const date = this.dataset.date;
                const notes = this.dataset.notes;

                // Populate the modal form
                document.getElementById('edit-expense-id').value = expenseId;
                document.getElementById('edit-amount').value = amount;
                document.getElementById('edit-category').value = category;
                document.getElementById('edit-date').value = date;
                document.getElementById('edit-notes').value = notes;

                // Update form action URL
                document.getElementById('editExpenseForm').action = `/expenses/edit/${expenseId}/`;

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editExpenseModal'));
                modal.show();
            });
        });

        // Validate edit form
        document.getElementById('editExpenseForm').addEventListener('submit', function(e) {
            const amount = parseFloat(document.getElementById('edit-amount').value);
            const category = document.getElementById('edit-category').value;
            
            if (isNaN(amount) || amount <= 0) {
                e.preventDefault();
                alert('⚠️ Please enter a valid amount greater than zero.');
                return false;
            }
            
            if (amount > 999999999.99) {
                e.preventDefault();
                alert('⚠️ Amount is too large. Maximum is ₱999,999,999.99');
                return false;
            }
            
            if (!category || category === '') {
                e.preventDefault();
                alert('⚠️ Please select a category.');
                return false;
            }
            
            return true;
        });
    </script>
</main>
{% endblock %}