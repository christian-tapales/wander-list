{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block content %}
  <div class="container-fluid d-flex">
    <!-- Main Content (Budget Setup Form) -->
    <div class="container py-4" style="flex-grow: 1;">
      <h1 class="h3 mb-3">Budget Alerts</h1>

      <!-- Flash messages -->
      <!--{% if messages %}
        <div class="mb-3">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}-->

      <!-- Budget Setup Form -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">Set New Budget Alert</div>
        <div class="card-body">
          <form method="post" novalidate id="budgetAlertForm">
            {% csrf_token %}
            <div class="row g-3">
              <!-- Category -->
              <div class="col-12 col-md-4">
                {{ form.category_choice.label_tag }}
                {{ form.category_choice }}
                {% if form.category_choice.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.category_choice.errors %}
                      {{ error }}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>

              <!-- Custom Category (shown only when "Others" selected) -->
              <div class="col-12 col-md-4" id="customCategoryDiv" style="{% if form.category_choice.value != 'Others' %}display: none;{% endif %}">
                {{ form.custom_category.label_tag }}
                {{ form.custom_category }}
                <div id="category_warning" class="alert alert-info mt-2" style="display: none;"></div>
                {% if form.custom_category.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.custom_category.errors %}
                      {{ error }}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>

              <!-- Amount Limit -->
              <div class="col-12 col-md-4">
                {{ form.amount_limit.label_tag }}
                <div class="input-group">
                  <span class="input-group-text">₱</span>
                  {{ form.amount_limit }}
                </div>
                {% if form.amount_limit.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.amount_limit.errors %}
                      {{ error }}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>

              <!-- Trigger -->
              <div class="col-12">
                <label class="form-label d-flex justify-content-between" for="{{ form.threshold_percent.id_for_label }}">
                  <span>{{ form.threshold_percent.label }}</span>
                  <span id="threshold_value_display" class="fw-semibold">{{ form.threshold_percent.value|default:80 }}%</span>
                </label>
                {{ form.threshold_percent }}
                <div class="form-text">Alert triggers when usage reaches this percentage.</div>
                {% if form.threshold_percent.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.threshold_percent.errors %}
                      {{ error }}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- Notifications -->
            <div class="row g-3 mt-1">
              <div class="col-12">
                <label class="form-label">Notifications</label>
                <div class="d-flex flex-wrap gap-3">
                  <div class="form-check">
                    {{ form.notify_dashboard }}
                    {{ form.notify_dashboard.label_tag }}
                  </div>
                  <div class="form-check">
                    {{ form.notify_email }}
                    {{ form.notify_email.label_tag }}
                  </div>
                  <div class="form-check">
                    {{ form.notify_push }}
                    {{ form.notify_push.label_tag }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Hidden field for active status -->
            {{ form.active }}

            <div class="mt-4 d-flex gap-2">
              <button type="submit" class="btn btn-success">Save Alert</button>
              <button type="reset" class="btn btn-outline-secondary">Clear</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Active Budget Alerts Table -->
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">Active Budget Alerts</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table align-middle table-striped mb-0">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Limit</th>
                  <th>Trigger</th>
                  <th>Notifications</th>
                  <th>Status</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for a in alerts %}
                  <tr>
                    <td>{{ a.category }}</td>
                    <td>₱{{ a.amount_limit }}</td>
                    <td>{{ a.threshold_percent }}%</td>
                    <td>
                      {% if a.notify_dashboard %}Dashboard{% endif %}
                      {% if a.notify_email %}{% if a.notify_dashboard %}, {% endif %}Email{% endif %}
                      {% if a.notify_push %}{% if a.notify_dashboard or a.notify_email %}, {% endif %}Push{% endif %}
                    </td>
                    <td>
                      {% if a.active %}
                        <span class="badge bg-success">Active</span>
                      {% else %}
                        <span class="badge bg-secondary">Disabled</span>
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <!-- Edit Button -->
                      <a href="{% url 'edit_alert' a.id %}" class="btn btn-sm btn-outline-warning">Edit</a>
                      <!-- Delete Button -->
                      <form method="POST" action="{% url 'delete_alert' a.id %}" style="display: inline;" onsubmit="return confirmDeleteAlert('{{ a.category }}');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                      </form>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="6" class="text-center text-muted">No alerts yet.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ignore benign placeholder image load errors (prevents the unrelated error toast) -->
  <script>
    window.addEventListener('error', function (e) {
      try {
        // resource loading errors often populate `e.filename` in modern browsers
        if (e && e.filename && e.filename.includes('via.placeholder.com')) {
          // swallow this specific benign error so it doesn't fire global error handlers/toasts
          e.stopImmediatePropagation?.();
          return;
        }
        // If the error target is an element (like <img>), check its src as well
        if (e && e.target && e.target instanceof Element) {
          const src = e.target.getAttribute && (e.target.getAttribute('src') || e.target.style?.backgroundImage);
          if (src && src.includes('via.placeholder.com')) {
            e.stopImmediatePropagation?.();
            return;
          }
        }
      } catch (err) {
        // ignore any edge-case errors inside this guard
      }
      // allow other errors to propagate normally
    }, true);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'css/budget_alerts.js' %}"></script>
  
  <script>
    // Initialize threshold display
    function updateThresholdValue(value) {
      document.getElementById('threshold_value_display').textContent = value + '%';
    }
    
    // Confirm deletion
    function confirmDeleteAlert(categoryName) {
      return confirm(`Are you sure you want to delete the budget alert for "${categoryName}"?\n\nThis action cannot be undone.`);
    }
  </script>
{% endblock %}
